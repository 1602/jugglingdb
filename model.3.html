<!DOCTYPE html>
<html>
<head>
  <meta http-equiv='content-type' value='text/html;charset=utf8'>
  <meta name='generator' value='Ronn/v0.7.3 (http://github.com/rtomayko/ronn/tree/0.7.3)'>
  <title>jugglingdb-model(3) - Model methods, features and internals</title>
  <style type='text/css' media='all'>
  /* style: man */
  body#manpage {margin:0}
  .mp {max-width:100ex;padding:0 9ex 1ex 4ex}
  .mp p,.mp pre,.mp ul,.mp ol,.mp dl {margin:0 0 20px 0}
  .mp h2 {margin:10px 0 0 0}
  .mp > p,.mp > pre,.mp > ul,.mp > ol,.mp > dl {margin-left:8ex}
  .mp h3 {margin:0 0 0 4ex}
  .mp dt {margin:0;clear:left}
  .mp dt.flush {float:left;width:8ex}
  .mp dd {margin:0 0 0 9ex}
  .mp h1,.mp h2,.mp h3,.mp h4 {clear:left}
  .mp pre {margin-bottom:20px}
  .mp pre+h2,.mp pre+h3 {margin-top:22px}
  .mp h2+pre,.mp h3+pre {margin-top:5px}
  .mp img {display:block;margin:auto}
  .mp h1.man-title {display:none}
  .mp,.mp code,.mp pre,.mp tt,.mp kbd,.mp samp,.mp h3,.mp h4 {font-family:monospace;font-size:14px;line-height:1.42857142857143}
  .mp h2 {font-size:16px;line-height:1.25}
  .mp h1 {font-size:20px;line-height:2}
  .mp {text-align:justify;background:#fff}
  .mp,.mp code,.mp pre,.mp pre code,.mp tt,.mp kbd,.mp samp {color:#131211}
  .mp h1,.mp h2,.mp h3,.mp h4 {color:#030201}
  .mp u {text-decoration:underline}
  .mp code,.mp strong,.mp b {font-weight:bold;color:#131211}
  .mp em,.mp var {font-style:italic;color:#232221;text-decoration:none}
  .mp a,.mp a:link,.mp a:hover,.mp a code,.mp a pre,.mp a tt,.mp a kbd,.mp a samp {color:#0000ff}
  .mp b.man-ref {font-weight:normal;color:#434241}
  .mp pre {padding:0 4ex}
  .mp pre code {font-weight:normal;color:#434241}
  .mp h2+pre,h3+pre {padding-left:0}
  ol.man-decor,ol.man-decor li {margin:3px 0 10px 0;padding:0;float:left;width:33%;list-style-type:none;text-transform:uppercase;color:#999;letter-spacing:1px}
  ol.man-decor {width:100%}
  ol.man-decor li.tl {text-align:left}
  ol.man-decor li.tc {text-align:center;letter-spacing:4px}
  ol.man-decor li.tr {text-align:right;float:right}
  </style>
  <style type='text/css' media='print'>
  /* style: print */
  .mp {max-width:none}
  .man-navigation {display:none !important}
  .mp a[href]:not([href^="#"]):not([data-bare-link]):after {content:" " attr(href)}
  </style>
  <style type='text/css' media='all'>
  /* style: toc */
  .man-navigation {display:block !important;position:fixed;top:0;left:113ex;height:100%;width:100%;padding:48px 0 0 0;border-left:1px solid #dbdbdb;background:#eee}
  .man-navigation a,.man-navigation a:hover,.man-navigation a:link,.man-navigation a:visited {display:block;margin:0;padding:5px 2px 5px 30px;color:#999;text-decoration:none}
  .man-navigation a:hover {color:#111;text-decoration:underline}
  </style>
</head>
<!--
  The following styles are deprecated and will be removed at some point:
  div#man, div#man ol.man, div#man ol.head, div#man ol.man.

  The .man-page, .man-decor, .man-head, .man-foot, .man-title, and
  .man-navigation should be used instead.
-->
<body id='manpage'>
  <div class='mp' id='man'>

  <div class='man-navigation' style='display:none'>
    <a href="#NAME">NAME</a>
    <a href="#DESCRIPTION">DESCRIPTION</a>
    <a href="#DB-WRITE-METHODS">DB WRITE METHODS</a>
    <a href="#DB-READ-METHODS">DB READ METHODS</a>
    <a href="#RELATIONS">RELATIONS</a>
    <a href="#SEE-ALSO">SEE ALSO</a>
  </div>

  <ol class='man-decor man-head man head'>
    <li class='tl'>jugglingdb-model(3)</li>
    <li class='tc'>JugglingDB</li>
    <li class='tr'>jugglingdb-model(3)</li>
  </ol>

  <h2 id="NAME">NAME</h2>
<p class="man-name">
  <code>jugglingdb-model</code> - <span class="man-whatis">Model methods, features and internals</span>
</p>

<h2 id="DESCRIPTION">DESCRIPTION</h2>

<p>This section describes common methods of models managed by jugglingdb and
explains some model internals, such as data representation, setters, getters and
virtual attributes.</p>

<h2 id="DB-WRITE-METHODS">DB WRITE METHODS</h2>

<p>Database write methods performs hooks and validations. See <a class="man-ref" href="hooks.3.html">jugglingdb-hooks<span class="s">(3)</span></a>
and <a class="man-ref" href="validations.3.html">jugglingdb-validations<span class="s">(3)</span></a> to learn how hooks and validations works.</p>

<h3 id="Model-create-data-callback-">Model.create([data[, callback]]);</h3>

<p>Create instance of Model with given data and save to database.
Invoke callback when ready. Callback accepts two arguments: error and model
instance.</p>

<pre><code>User.create({name: 'Jared Hanson'}, function(err, user) {
    console.log(user instanceof User);
});
</code></pre>

<p>When called with array of objects as first argument <code>Model.create</code> creates bunch
of records. Both <code>err</code> and <code>model instance</code> arguments passed to callback will be
arrays then. When no errors happened <code>err</code> argument will be null.</p>

<p>The value returned from <code>Model.create</code> depends on second argument too. In case
of Array it will return an array of instances, otherwise single instance. But be
away, this instance(s) aren't save to database yet and you have to wait until
callback called to be able to do id-sensitive stuff.</p>

<h3 id="Model-prototype-save-options-callback-">Model.prototype.save([options[, callback]]);</h3>

<p>Save instance to database, options is an object {validate: true, throws: false},
it allows to turn off validation (turned on by default) and throw error on
validation error (doesn't throws by default).</p>

<pre><code>user.email = 'incorrect email';
user.save({throws: true}, callback); // will throw ValidationError
user.save({validate: false}, callback); // will save incorrect data
user.save(function(err, user) {
    console.log(err); // ValidationError
    console.log(user.errors); // some errors
});
</code></pre>

<h3 id="Model-prototype-updateAttributes-data-callback-">Model.prototype.updateAttributes(data[, callback]);</h3>

<p>Save specified attributes database.
Invoke callback when ready. Callback accepts two arguments: error and model
instance.</p>

<pre><code>user.updateAttributes({
    email: 'new-email@example.com',
    name: 'New Name'
}, callback);
</code></pre>

<h3 id="Model-prototype-updateAttribute-key-value-callback-">Model.prototype.updateAttribute(key, value[, callback]);</h3>

<p>Shortcut for updateAttributes, but for one field, works in the save way as
updateAttributes.</p>

<pre><code>user.updateAttribute('email', 'new-email@example.com', callback);
</code></pre>

<h3 id="Model-upsert-data-callback-">Model.upsert(data, callback)</h3>

<p>Update when record with id=data.id found, insert otherwise. Be aware: no
setters, validations or hooks applied when use upsert. This is seed-friendly
method.</p>

<h3 id="Model-prototype-destroy-callback-">Model.prototype.destroy([callback]);</h3>

<p>Delete database record.
Invoke callback when ready. Callback accepts two arguments: error and model
instance.</p>

<pre><code>model.destroy(function(err) {
    // model instance destroyed
});
</code></pre>

<h3 id="Model-destroyAll-callback-">Model.destroyAll(callback)</h3>

<p>Delete all Model instances from database. Be aware: <code>destroyAll</code> method doesn't
perform destroy hooks.</p>

<h3 id="Model-iterate-options-iterator-callback-">Model.iterate(options, iterator, callback)</h3>

<p>Iterate through dataset and perform async method iterator. This method designed
to work with large datasets loading data by batches. First argument (options) is
optional and have same signature as for Model.all, it has additional member
<code>batchSize</code> which allows to specify size of batch loaded into memory from the
database.</p>

<p>Iterator argument is a function that accepts three arguments: item, callback and
index in collection.</p>

<pre><code>Model.iterate({batchSize: 100}, function(obj, next, i) {
    doSomethingAsync(obj, next);
}, function(err) {
    // all done
});
</code></pre>

<h2 id="DB-READ-METHODS">DB READ METHODS</h2>

<h3 id="Model-find-id-callback-">Model.find(id, callback);</h3>

<p>Find instance by id.
Invoke callback when ready. Callback accepts two arguments: error and model
instance.</p>

<h3 id="Model-all-params-callback-">Model.all([params, ]callback);</h3>

<p>Find all instances of Model, matched by query. Fields used for filter and sort
should be declared with <code>{index: true}</code> in model definition.</p>

<ul>
<li><p><code>param</code>:</p>

<ul>
<li>where: Object <code>{ key: val, key2: {gt: 'val2'}}</code></li>
<li>include: String, Object or Array. See AbstractClass.include documentation.</li>
<li>order: String</li>
<li>limit: Number</li>
<li>skip: Number</li>
</ul>
</li>
<li><p><code>callback</code>:
Accepts two arguments:</p>

<ul>
<li>err (null or Error)</li>
<li>Array of instances</li>
</ul>
</li>
</ul>


<h3 id="Model-count-query-callback-">Model.count([query, ]callback);</h3>

<p>Query count of instances stored in database. Optional <code>query</code> param allows to
count filtered set of records. Callback called with error and count arguments.</p>

<pre><code>User.count({approved: true}, function(err, count) {
    console.log(count); // count of approved users stored in database
});
</code></pre>

<h2 id="RELATIONS">RELATIONS</h2>

<h3 id="hasMany">hasMany</h3>

<p>Define all necessary stuff for "one to many" relation:</p>

<ul>
<li>foreign key in "many" model</li>
<li>named scope in "one" model</li>
</ul>


<p>Example:</p>

<pre><code>var Book = db.define('Book');
var Chapter = db.define('Chapters');

// syntax 1 (old):
Book.hasMany(Chapter);
// syntax 2 (new):
Book.hasMany('chapters');
</code></pre>

<p>Syntax 1 and 2 does same things in different ways: adds <code>chapters</code> method to
<code>Book.prototype</code> and add <code>bookId</code> property to <code>Chapter</code> model. Foreign key name
(<code>bookId</code>) could be specified manually using second param:</p>

<pre><code>Book.hasMany('chapters', {foreignKey: `chapter_id`});
</code></pre>

<p>When using syntax 2 jugglingdb looking for model with singularized name:</p>

<pre><code>'chapters' =&gt; 'chapter' =&gt; 'Chapter'
</code></pre>

<p>But it's possible to specify model manually using second param:</p>

<pre><code>Book.hasMany('stories', {model: Chapter});
</code></pre>

<p>Syntax 1 allows to override scope name using <code>as</code> property of second param:</p>

<pre><code>Book.hasMany(Chapter, {as: 'stories'});
</code></pre>

<p><strong>Scope methods</strong> created on BaseClass by hasMany allows to build, create and
query instances of other class. For example:</p>

<pre><code>Book.create(function(err, book) {
    // using 'chapters' scope for build:
    var c = book.chapters.build({name: 'Chapter 1'});
    // same as:
    c = new Chapter({name: 'Chapter 1', bookId: book.id});
    // using 'chapters' scope for create:
    book.chapters.create();
    // same as:
    Chapter.create({bookId: book.id});

    // using scope for querying:
    book.chapters(function() {/* all chapters with bookId = book.id */ });
    book.chapters({where: {name: 'test'}, function(err, chapters) {
        // all chapters with bookId = book.id and name = 'test'
    });
});
</code></pre>

<h3 id="belongsTo">belongsTo</h3>

<p>TODO: document</p>

<h3 id="hasAndBelongsToMany">hasAndBelongsToMany</h3>

<p>TODO: document</p>

<h2 id="SEE-ALSO">SEE ALSO</h2>

<p><a class="man-ref" href="schema.3.html">jugglingdb-schema<span class="s">(3)</span></a>
<a class="man-ref" href="validations.3.html">jugglingdb-validations<span class="s">(3)</span></a>
<a class="man-ref" href="hooks.3.html">jugglingdb-hooks<span class="s">(3)</span></a>
<a class="man-ref" href="adapter.3.html">jugglingdb-adapter<span class="s">(3)</span></a></p>


  <ol class='man-decor man-foot man foot'>
    <li class='tl'>1602 Software</li>
    <li class='tc'>October 2013</li>
    <li class='tr'>jugglingdb-model(3)</li>
  </ol>

  </div>
</body>
</html>
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39555551-1', 'jugglingdb.co');
    ga('send', 'pageview');

</script>
<script>
    var filename = location.href.match(/([^\/]+)?\.3.html(#.*?)?$/);
    if (!filename) {
        filename = [null, 'jugglingdb'];
    }
    var div = document.createElement('div');
    div.innerHTML = 'Found a typo? ' +
        linkTo('View', 'blob') +
        ' and ' +
        'edit' +
        //linkTo('edit', 'edit') +
        ' this file online at GitHub.';

    document.getElementById('man').appendChild(div);

    function linkTo(text, dir) {
        return '<a href="https://github.com/1602/jugglingdb/' +
            dir + '/master/docs/' + filename[1] + '.md">' + text + '</a>';
    }

    addLink('h3', '&para;');
    addLink('h2', '&sect;');

    function addLink(tag, sign) {
        var els = document.getElementsByTagName(tag);
        for (var i = 0; i < els.length; i += 1) {
            var el = els[i];
            el.innerHTML = '<a class="section-link" href="#' + el.id +
                '">' + sign + '</a>' + el.innerHTML;
            // el.style = 'margin-left: -1em';
        }
    }
</script>
<style>
    .section-link {
        visibility: hidden;
    }

    .mp h1, .mp h2, .mp h3 {
        position: relative;
        left: -1em;
    }

    a.section-link:hover,
    a.section-link:link,
    a.section-link {
        color: #999;
        text-decoration: none;
    }

    h1:hover .section-link,
    h2:hover .section-link,
    h3:hover .section-link {
        visibility: visible;
    }

    .mp pre code {
        color: #565758;
    }

    /*
    pre {
        background: #eee;
    }
    */
</style>
